<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文件交接</title>
    <style>
        body {
            font-family: 'Times New Roman', Times, serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f5f5f5;
        }
        .container {
            border: 2px solid #FF0000;
            padding: 25px;
            border-radius: 5px;
            background-color: white;
            width: 400px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .logo {
            font-size: 20px;
            font-weight: bold;
            color: #FF0000;
            text-transform: lowercase;
            width: 70px;
        }
        h2 {
            color: #000000;
            font-size: 22px;
            margin: 0;
            text-align: center;
            flex-grow: 1;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-row {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        label {
            width: 80px;
            font-weight: bold;
            color: #000000;
        }
        .display-value {
            flex-grow: 1;
            padding: 8px;
            background-color: #f5f5f5;
            border-radius: 4px;
        }
        .personnel-label {
            color: #0000FF;
            font-weight: bold;
            width: 60px;
            text-align: right;
            margin-right: 10px;
        }
        select {
            padding: 7px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Times New Roman', Times, serif;
            font-size: 14px;
            width: 150px;
            color: #0000FF;
        }
        .arrow {
            margin: 0 10px;
            font-size: 18px;
            font-weight: bold;
            color: #FF0000;
        }
        .footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        button {
            padding: 8px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Times New Roman', Times, serif;
            font-size: 15px;
            width: 100%;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">porite</div>
            <h2>文件交接</h2>
            <div style="width: 70px;"></div>
        </div>
        
        <div class="form-group">
            <div class="form-row">
                <label>文件名称:</label>
                <div class="display-value" id="fileDisplay"></div>
            </div>
            
            <div class="form-row">
                <label>交接时间:</label>
                <div class="display-value" id="timeDisplay"></div>
            </div>
            
            <div class="form-row" style="justify-content: center;">
                <div class="personnel-label">本人</div>
                <select id="sender"></select>
                <span class="arrow">→</span>
                <div class="personnel-label">接收</div>
                <select id="receiver"></select>
            </div>
        </div>
        
        <div class="footer">
            <button id="submitBtn">提交</button>
        </div>
    </div>

    <script>
        // 解析URL参数
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                file: decodeURIComponent(params.get('file') || '未指定文件'),
                personnel: (params.get('personnel') || '').split(',')
            };
        }

        // 获取企业微信用户真实姓名
        function getWeComUser() {
            return new Promise((resolve) => {
                if (window.__wxjs_environment === 'wxwork' || 
                    navigator.userAgent.toLowerCase().indexOf('wxwork') > -1) {
                    if (window.wx && wx.invoke) {
                        wx.invoke('getContext', {}, function(res) {
                            if (res.err_msg === 'getContext:ok') {
                                wx.invoke('getUserInfo', {
                                    corpid: res.corpId,
                                    userId: res.userId
                                }, function(userRes) {
                                    if (userRes.err_msg === 'getUserInfo:ok') {
                                        resolve(userRes.userInfo.name);
                                    } else {
                                        resolve(null);
                                    }
                                });
                            } else {
                                resolve(null);
                            }
                        });
                    } else {
                        resolve('当前用户');
                    }
                } else {
                    resolve(null);
                }
            });
        }

        // 初始化页面
        async function init() {
            const params = getUrlParams();
            document.getElementById('fileDisplay').textContent = params.file;
            
            updateTimeDisplay();
            setInterval(updateTimeDisplay, 1000);
            
            const weComUser = await getWeComUser();
            
            const personnel = params.personnel.filter(p => p.trim() !== '');
            const senderSelect = document.getElementById('sender');
            const receiverSelect = document.getElementById('receiver');
            
            personnel.forEach(person => {
                const option = document.createElement('option');
                option.value = person;
                option.textContent = person;
                senderSelect.appendChild(option.cloneNode(true));
                receiverSelect.appendChild(option.cloneNode(true));
            });
            
            if (weComUser) {
                let userExists = false;
                for (let i = 0; i < senderSelect.options.length; i++) {
                    if (senderSelect.options[i].text === weComUser) {
                        userExists = true;
                        break;
                    }
                }
                
                if (!userExists) {
                    const option = document.createElement('option');
                    option.value = weComUser;
                    option.textContent = weComUser;
                    senderSelect.insertBefore(option, senderSelect.firstChild);
                }
                senderSelect.value = weComUser;
            }
            
            // 提交按钮事件
            document.getElementById('submitBtn').addEventListener('click', function() {
                const sender = document.getElementById('sender').value;
                const receiver = document.getElementById('receiver').value;
                const file = getUrlParams().file;
                const time = document.getElementById('timeDisplay').textContent;
                
                if (!sender || !receiver) {
                    alert('请选择本人和接收人');
                    return;
                }
                
                if (sender === receiver) {
                    alert('本人和接收人不能相同');
                    return;
                }
                
                // 构建邮件内容（确保三行格式）
                const subject = `【文件交接】${file}_${sender} → ${receiver}`;
                const body = 
`文件名称: ${file}
交接时间: ${time}
交接人员: ${sender} → ${receiver}`;
                
                // 编码处理
                const encodedBody = encodeURIComponent(body)
                    .replace(/%20/g, ' ')
                    .replace(/%0A/g, '%0D%0A'); // 确保Foxmail换行
                
                // 发送邮件
                window.location.href = `mailto:lium@porite.com.cn?subject=${encodeURIComponent(subject)}&body=${encodedBody}`;
                
                // 禁用按钮防止重复提交
                this.disabled = true;
                this.textContent = '已提交';
                this.style.backgroundColor = '#cccccc';
                
                // 存储提交状态
                sessionStorage.setItem('submitted_' + encodeURIComponent(file), 'true');
            });
        }

        // 更新时间显示
        function updateTimeDisplay() {
            const now = new Date();
            const timeString = now.getFullYear() + '-' + 
                String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                String(now.getDate()).padStart(2, '0') + ' ' + 
                String(now.getHours()).padStart(2, '0') + ':' + 
                String(now.getMinutes()).padStart(2, '0') + ':' + 
                String(now.getSeconds()).padStart(2, '0');
            
            document.getElementById('timeDisplay').textContent = timeString;
            return timeString;
        }

        // 页面加载时初始化
        window.onload = init;
    </script>
</body>
</html>
